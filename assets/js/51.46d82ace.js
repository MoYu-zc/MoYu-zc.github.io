(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{470:function(s,a,t){"use strict";t.r(a);var e=t(15),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis持久化"}},[s._v("#")]),s._v(" Redis持久化")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("Redis是内存数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失，所以Redis提供了持久化功能")])])]),s._v(" "),t("h2",{attrs:{id:"rdb（redis-database）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rdb（redis-database）"}},[s._v("#")]),s._v(" RDB（Redis DataBase）")]),s._v(" "),t("h3",{attrs:{id:"什么是rdb"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是rdb"}},[s._v("#")]),s._v(" 什么是RDB")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426130147.png",alt:"2"}})]),s._v(" "),t("blockquote",[t("p",[s._v("在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是"),t("code",[s._v("Snapshot快照")]),s._v("，它恢复时是将快照文件直接读到内存里。")]),s._v(" "),t("p",[s._v("Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个"),t("code",[s._v("临时RDB文件")]),s._v("中，等持久化过程都结束了，再用这个临时文件替换上次已经持久化完成的文件。整个过程中，主进程是不进行任何IO操作的。")]),s._v(" "),t("p",[s._v("这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那"),t("code",[s._v("RDB方式")]),s._v("要比"),t("code",[s._v("AOF方式")]),s._v("更加的高效。RDB的缺点是最后一次持久化后的数据可能丢失。一般默认的是"),t("code",[s._v("RDB")]),s._v(" , 不需要修改文件。")]),s._v(" "),t("p",[s._v("==他一般保存在 "),t("code",[s._v("dump.rdb")]),s._v(" 文件中==")])]),s._v(" "),t("p",[s._v("可以查看 "),t("code",[s._v("redis.conf")]),s._v(" 中的 "),t("code",[s._v("SNAPSHOTTING")]),s._v(":")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426125348.png",alt:"1"}})]),s._v(" "),t("p",[s._v("当你满足制定的规则时，就会生成 "),t("code",[s._v("dump.rdb")]),s._v(" 文件，该文件名可以在配置文件中进行修改。")]),s._v(" "),t("h3",{attrs:{id:"触发机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#触发机制"}},[s._v("#")]),s._v(" "),t("strong",[s._v("触发机制")])]),s._v(" "),t("p",[s._v("1，"),t("code",[s._v("save的规则")]),s._v("满足的情况下，会自动触发rdb规则")]),s._v(" "),t("p",[s._v("2、执行"),t("code",[s._v("flushall")]),s._v("命令，也会触发我们的rdb规则")]),s._v(" "),t("p",[s._v("3、"),t("code",[s._v("退出redis")]),s._v("，也会产生rdb文件")]),s._v(" "),t("h3",{attrs:{id:"恢复rdb文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#恢复rdb文件"}},[s._v("#")]),s._v(" 恢复rdb文件")]),s._v(" "),t("p",[s._v("1、只需要将rdb文件放在我们redis启动目录就可以，redis启动的时候会自动检查"),t("code",[s._v("dump.rdb")]),s._v("恢复其中的数据")]),s._v(" "),t("p",[s._v("2、查看需要存在的位置")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" config get "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("dir")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dir"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/local/bin"')]),s._v("         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#如果在这个目录下存在dump.rdb文件，启动就会自动恢复其中的数据")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h3",{attrs:{id:"优缺点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优缺点"}},[s._v("#")]),s._v(" 优缺点")]),s._v(" "),t("p",[t("strong",[s._v("优点：")])]),s._v(" "),t("ol",[t("li",[s._v("适合大规模的数据恢复")]),s._v(" "),t("li",[s._v("对数据的完整性要不高")])]),s._v(" "),t("p",[t("strong",[s._v("缺点:")])]),s._v(" "),t("ol",[t("li",[s._v("需要一定的时间间隔进程操作")]),s._v(" "),t("li",[s._v("如果redis意外宕机了，这个最后一次修改数据就没有的了")]),s._v(" "),t("li",[s._v("fork进程的时候，会占用一定的内容空间")])]),s._v(" "),t("h2",{attrs:{id:"aof（append-only-file）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#aof（append-only-file）"}},[s._v("#")]),s._v(" AOF（Append Only File）")]),s._v(" "),t("h3",{attrs:{id:"什么是aof"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是aof"}},[s._v("#")]),s._v(" 什么是AOF")]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("将我们的所有命令都记录下来，history，恢复的时候就把这个文件全部在执行一遍")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426135506.png",alt:"3"}})]),s._v(" "),t("blockquote",[t("p",[s._v("以"),t("code",[s._v("日志")]),s._v("的形式来记录每个写操作，将Redis执行过的所有指令记录下来（"),t("code",[s._v("读操作不记录")]),s._v("），"),t("strong",[s._v("只允许追加文件但不可以改写文件")]),s._v("，redis启动之初会读取该文件重新构建数据，也就是说，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作")]),s._v(" "),t("p",[s._v("==AOF保存的是 "),t("code",[s._v("appendonly.aof")]),s._v(" 文件==")])]),s._v(" "),t("h3",{attrs:{id:"开启aof"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开启aof"}},[s._v("#")]),s._v(" 开启AOF")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426140056.png",alt:"4"}})]),s._v(" "),t("p",[s._v("这里默认是不开启的，需要我们修改为 "),t("code",[s._v("yes")]),s._v("  , 这样就开启了 AOF")]),s._v(" "),t("p",[s._v("开启之后，重启Redis，之后我们查看 "),t("code",[s._v("/usr/local/bin")]),s._v(" 路径下")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426140500.png",alt:"5"}})]),s._v(" "),t("h3",{attrs:{id:"修复aof"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修复aof"}},[s._v("#")]),s._v(" 修复AOF")]),s._v(" "),t("blockquote",[t("p",[s._v("如果这个"),t("code",[s._v(".aof")]),s._v("文件 被无意或者人为损坏了，这时候 redis是无法连接的，而这个时候，我们就需要修复这个aof文件。")])]),s._v(" "),t("p",[s._v("我们先来测试一下，")]),s._v(" "),t("ul",[t("li",[s._v("在redis中保存数据")]),s._v(" "),t("li",[s._v("修改aof文件")]),s._v(" "),t("li",[s._v("重新启动redis")]),s._v(" "),t("li",[s._v("修复AOF")])]),s._v(" "),t("h4",{attrs:{id:"_1-redis保存数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-redis保存数据"}},[s._v("#")]),s._v(" 1.redis保存数据")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" k1 v1     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保存k1:v1")]),s._v("\nOK\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" k2 v2     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#保存k2:v2")]),s._v("\nOK\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:637"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("9")]),s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#关闭redis")]),s._v("\nnot connected"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h4",{attrs:{id:"_2-查看并修改文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-查看并修改文件"}},[s._v("#")]),s._v(" 2.查看并修改文件")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" appendonly.aof\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("没修改的：")]),s._v(" "),t("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426143223.png",alt:"6"}}),s._v(" "),t("p",[s._v("修改过的：")]),s._v(" "),t("img",{staticStyle:{zoom:"80%"},attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426143230.png",alt:"7"}}),s._v(" "),t("h4",{attrs:{id:"_3-尝试启动redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-尝试启动redis"}},[s._v("#")]),s._v(" 3.尝试启动redis")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426143330.png",alt:"8"}})]),s._v(" "),t("p",[s._v("很明显，因为aof文件被修改，redis无法启动了")]),s._v(" "),t("h4",{attrs:{id:"_4-修复redis"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-修复redis"}},[s._v("#")]),s._v(" 4.修复redis")]),s._v(" "),t("blockquote",[t("p",[s._v("redis提供了一个修复工具 "),t("code",[s._v("redis-check-aof")])])]),s._v(" "),t("p",[s._v("修复语句：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("redis-check-aof --fix appendonly.aof\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"https://gitee.com/MoYu-zc/picgo/raw/master/img/20210426143641.png",alt:"9"}})]),s._v(" "),t("p",[s._v("这时候查看aof文件，会发现已经恢复成修改前的样子了。")]),s._v(" "),t("p",[t("strong",[s._v("这时候，再次进行启动redis，就可以成功了")])]),s._v(" "),t("h3",{attrs:{id:"优缺点-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#优缺点-2"}},[s._v("#")]),s._v(" 优缺点")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("appendonly no   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#默认是不开启aof模式的，默认是使用rdb方式持久化的，在大部分所有的情况下，rdb完全够用")]),s._v("\nappendfilename "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"appendonly.aof"')]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#持久化的文件的名字")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#appendfsync always       #每次修改都会sync。消耗性能")]),s._v("\nappendfsync everysec      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#每秒执行一次sync，可能会损失这1s的数据")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#appendfsync no           #不执行sync，这个时候操作系统自己同步数据，速度最快")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重写机制")]),s._v("\nauto-aof-rewrite-percentage "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#两倍大小时重写")]),s._v("\nauto-aof-rewrite-min-size 64mb    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#重写文件最小体积，默认为64mb，超过这个数值，会fork一个新线程将我们的文件重写")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[t("strong",[s._v("优点：")])]),s._v(" "),t("ol",[t("li",[s._v("每一次修改都同步，文件的完整会更加好")]),s._v(" "),t("li",[s._v("每秒同步一次，可能会丢失一秒的数据")]),s._v(" "),t("li",[s._v("从不同步，效率最高的")])]),s._v(" "),t("p",[t("strong",[s._v("缺点：")])]),s._v(" "),t("ol",[t("li",[s._v("相对于数据文件来说，aof远远大于rdb，修复的速度也比rdb慢")]),s._v(" "),t("li",[s._v("Aof运行效率也要比rdb慢，所以我们redis默认的配置就是rdb持久化")])]),s._v(" "),t("h2",{attrs:{id:"扩展"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#扩展"}},[s._v("#")]),s._v(" 扩展")]),s._v(" "),t("p",[s._v("1、RDB持久化方式能够在指定的时间间隔内对你的数据进行快照存储")]),s._v(" "),t("p",[s._v("2，AOF持久化方式记录每次对服务器写的操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，AOF命令以Redis协议追加保存每次写的操作到文件末尾，Redis还能对AOF文件进行后台重写，使得AOF文件的体积不至于过大。")]),s._v(" "),t("p",[s._v("3、只做缓存，如果你只希望你的数据在服务器运行的时候存在，你也可以不使用任何持久化")]),s._v(" "),t("p",[s._v("4、同时开启两种持久化方式")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("在这种情况下，当redis重启的时候会优先载入AOF文件来恢复原始的数据，因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整。")])]),s._v(" "),t("li",[t("p",[s._v("RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件，那要不要只使用AOF呢？作者建议不要，因为RDB更适合用于备份数据库（AOF在不断变化不好备份），快速重启，而且不会有AOF可能潜在的Bug，留着作为一个万一的手段。")])])]),s._v(" "),t("p",[s._v("5、性能建议")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留save 900 1这条规则。")])]),s._v(" "),t("li",[t("p",[s._v("如果Enable AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了，代价一是带来了持续的10，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上，默认超过原大小100%大小重写可以改到适当的数值。")])]),s._v(" "),t("li",[t("p",[s._v("如果不Enable AOF，仅靠Master-Slave Repllcation实现高可用性也可以，能省掉一大笔10，也减少了rewrite时带来的系统波动。代价是如果Master/Slave同时出问题( 例如：突然断电 )，会丢失十几分钟的数据，启动脚本也要比较两个Master/Slave中的RDB文件，载入较新的那个。")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);